name: Build and Deploy Base Server

permissions:
  id-token: write  # Required for OIDC-based authentication
  contents: read   # Required for actions/checkout

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    name: Build and Test Golang Project
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: Install dependencies
        run: go mod download

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker images
        uses: actions/cache@v4
        with:
          path: /tmp/docker-cache
          key: docker-${{ runner.os }}-${{ hashFiles('docker-compose.services.yml') }}
          restore-keys: |
            docker-${{ runner.os }}-

      - name: Load cached Docker images
        run: |
          if [ -d /tmp/docker-cache ]; then
            for image in /tmp/docker-cache/*.tar; do
              if [ -f "$image" ]; then
                docker load -i "$image" || true
              fi
            done
          fi

      - name: Create test environment file
        run: |
          cat > env.local << EOF
          # Database
          DB_HOST=localhost
          DB_USERNAME=base_user
          DB_PASSWORD=base_password
          DB_NAME=base_db

          # Authentication
          JWT_SECRET=test-jwt-secret-key-for-github-actions
          GOOGLE_CLIENT_ID=test-google-client-id
          GOOGLE_CLIENT_SECRET=test-google-client-secret
          GOOGLE_REDIRECT_URI=http://localhost:8080/auth/google/callback
          TURNSTILE_SECRET_KEY=some-key

          # Services (test/dummy values)
          STRIPE_SECRET_KEY=sk_test_dummy_key
          STRIPE_WEBHOOK_SECRET=whsec_test_dummy_secret
          RESEND_API_KEY=re_test_dummy_key
          OPENAI_API_KEY=sk-test-dummy-openai-key
          GOOGLE_AI_API_KEY=test-dummy-google-ai-key
          DEFAULT_EMAIL_SENDER_ADDRESS=test@example.com
          WEBAPP_URI=http://localhost:3000

          # Kafka
          KAFKA_BROKERS=localhost:9092
          KAFKA_TOPIC=webhook-events
          KAFKA_CONSUMER_GROUP=webhook-consumers

          # Server
          SERVER_PORT=8080
          EOF

      - name: Start services with docker-compose
        run: |
          docker compose -f docker-compose.services.yml up -d --wait db kafka
          docker compose -f docker-compose.services.yml up flyway

      - name: Build the application
        run: go build -v -o base-server .

      - name: Run unit tests (mocked - no DB needed)
        run: go test -coverprofile=coverage.out -covermode=atomic -short ./internal/.../processor/... ./internal/.../service/...

      - name: Run store tests (requires DB)
        run: go test -coverprofile=coverage-store.out -covermode=atomic -short ./internal/store/...

      - name: Run race detection
        if: github.event_name == 'push'
        run: go test -race -short ./...

      - name: Start API server in background
        run: |
          ./base-server &
          echo $! > server.pid
          # Wait for server to be ready
          timeout 30 bash -c 'until curl -s http://localhost:8080/health > /dev/null; do sleep 1; done'

      - name: Run integration tests
        env:
          TEST_API_HOST: localhost
          TEST_API_PORT: 8080
          TEST_DB_HOST: localhost
          TEST_DB_PORT: 5432
          TEST_DB_USER: base_user
          TEST_DB_PASS: base_password
          TEST_DB_NAME: base_db
        run: go test -v -race -tags=integration ./tests/...

      - name: Stop API server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
          fi

      - name: Display test coverage
        run: |
          echo "=== Unit test coverage ==="
          go tool cover -func=coverage.out
          echo ""
          echo "=== Store test coverage ==="
          go tool cover -func=coverage-store.out

      - name: Save Docker images to cache
        if: always()
        run: |
          mkdir -p /tmp/docker-cache
          docker save postgres:15-alpine -o /tmp/docker-cache/postgres.tar || true
          docker save flyway/flyway -o /tmp/docker-cache/flyway.tar || true
          docker save confluentinc/cp-kafka:latest -o /tmp/docker-cache/kafka.tar || true

      - name: Stop services
        if: always()
        run: docker compose -f docker-compose.services.yml down -v

  prepare-ecr:
    name: Prepare ECR Repository
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push'
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          role-to-assume: arn:aws:iam::339713122183:role/github-actions-admin-aws
          role-session-name: GitHubActions
          web-identity-token-file: ${{ github.token_path }}
      - name: Upsert ECR repository
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          aws ecr describe-repositories --repository-names $REPO_NAME || aws ecr create-repository --repository-name $REPO_NAME

  docker-build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: prepare-ecr
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          role-to-assume: arn:aws:iam::339713122183:role/github-actions-admin-aws
          role-session-name: GitHubActions
          web-identity-token-file: ${{ github.token_path }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ github.event.repository.name }}:${{ github.sha }}
            ${{ steps.login-ecr.outputs.registry }}/${{ github.event.repository.name }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-ecs:
      name: Deploy
      runs-on: ubuntu-latest
      needs: docker-build-and-push
      if: github.event_name == 'push'
      steps:
        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            aws-region: us-east-1
            role-to-assume: arn:aws:iam::339713122183:role/github-actions-admin-aws
            role-session-name: GitHubActions
            web-identity-token-file: ${{ github.token_path }}
        - name: Deploy to ECS
          run: |
            # Trigger ECS service redeployment with force flag
            aws ecs update-service --cluster ecs-cluster --service api_service --force-new-deployment --region us-east-1
